name: Android APK Derleme (Optimize EdilmiÅŸ)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v3
    
    - name: ğŸ Python Kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: â˜• Java Kurulumu
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: ğŸ“¦ Sistem BaÄŸÄ±mlÄ±lÄ±klarÄ±
      run: |
        sudo apt update
        sudo apt install -y \
          git zip unzip \
          autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev \
          libncursesw5-dev libtinfo6 \
          cmake libffi-dev libssl-dev \
          automake ccache libltdl-dev wget curl
    
    - name: ğŸ”§ Buildozer Kurulumu
      run: |
        pip install --upgrade pip
        pip install buildozer==1.5.0 cython==0.29.36

    # ====== Android SDK ve Build-Tools Kurulumu ======
    - name: ğŸ¤– Android SDK Kurulumu
      run: |
        ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        mkdir -p $ANDROID_HOME/cmdline-tools
        cd $ANDROID_HOME/cmdline-tools
        
        # Command line tools indir ve aÃ§
        curl -s -O https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        mkdir -p latest
        mv cmdline-tools/* latest/ 2>/dev/null || true
        rm commandlinetools-linux-11076708_latest.zip
        
        echo "âœ… Android Command Line Tools kuruldu"

    - name: ğŸŒ PATH Ayarla
      run: |
        echo "$HOME/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/.buildozer/android/platform/android-sdk/platform-tools" >> $GITHUB_PATH
        echo "$HOME/.buildozer/android/platform/android-sdk/build-tools/34.0.0" >> $GITHUB_PATH

    - name: ğŸ› ï¸ Android Build-Tools Kurulumu
      run: |
        ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH

        echo "ğŸ“¦ Android SDK bileÅŸenleri yÃ¼kleniyor..."
        yes | sdkmanager --licenses || true

        sdkmanager --install \
          "build-tools;34.0.0" \
          "platforms;android-33" \
          "platform-tools" \
          "cmdline-tools;latest"
        
        echo "âœ… Android SDK bileÅŸenleri kuruldu"

    - name: ğŸ” Kurulum DoÄŸrulama
      run: |
        ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0:$PATH

        echo "ğŸ“‹ Kurulu Build-Tools ve aidl kontrolÃ¼"
        which aidl || echo "âš ï¸ aidl PATH'de bulunamadÄ±"
        ls -la $ANDROID_HOME/build-tools/34.0.0/

    - name: ğŸ“ buildozer.spec OluÅŸtur/GÃ¼ncelle
      run: |
        if [ ! -f buildozer.spec ]; then
          buildozer init
        fi
        
        sed -i 's/title = .*/title = Wordle Oyunu/' buildozer.spec
        sed -i 's/package.name = .*/package.name = wordleoyunu/' buildozer.spec
        sed -i 's/package.domain = .*/package.domain = com.wordle/' buildozer.spec
        sed -i 's/source.include_exts = .*/source.include_exts = py,png,jpg,kv,atlas,txt,json,wav/' buildozer.spec
        sed -i 's/version = .*/version = 1.0.0/' buildozer.spec
        sed -i 's/requirements = .*/requirements = python3,kivy==2.2.1,kivymd,pillow,sdl2_ttf/' buildozer.spec
        sed -i 's/android.permissions = .*/android.permissions = INTERNET,ACCESS_NETWORK_STATE/' buildozer.spec
        sed -i 's/android.api = .*/android.api = 33/' buildozer.spec
        sed -i 's/android.minapi = .*/android.minapi = 21/' buildozer.spec
        sed -i 's/android.ndk = .*/android.ndk = 25b/' buildozer.spec
        sed -i 's/android.accept_sdk_license = .*/android.accept_sdk_license = True/' buildozer.spec
        sed -i 's/android.archs = .*/android.archs = arm64-v8a/' buildozer.spec

        if ! grep -q "android.build_tools_version" buildozer.spec; then
          echo "android.build_tools_version = 34.0.0" >> buildozer.spec
        fi

        if ! grep -q "android.sdk_path" buildozer.spec; then
          echo "android.sdk_path = $HOME/.buildozer/android/platform/android-sdk" >> buildozer.spec
        fi

        echo "âœ… buildozer.spec yapÄ±landÄ±rÄ±ldÄ±"

    - name: ğŸ’¾ Buildozer Cache
      uses: actions/cache@v3
      with:
        path: |
          .buildozer
          !.buildozer/android/platform/android-sdk
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}-v4
        restore-keys: |
          ${{ runner.os }}-buildozer-v4-

    - name: ğŸ—ï¸ APK Derleme
      run: |
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0:$PATH

        echo "ğŸš€ Derleme baÅŸlÄ±yor..."
        buildozer -v android debug
        echo "âœ… Derleme tamamlandÄ±!"

    - name: ğŸ“¤ APK Upload
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: wordle-apk
        path: bin/*.apk
        retention-days: 30

    - name: ğŸ‰ Release OluÅŸtur (Tag varsa)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“‹ Hata LoglarÄ± (Hata durumunda)
      if: failure()
      run: |
        echo "âŒ Derleme baÅŸarÄ±sÄ±z oldu!"
        tail -n 100 .buildozer/logs/last_log.txt || echo "Log dosyasÄ± bulunamadÄ±"
        
# --- Ã–nceki adÄ±mlar aynÄ± kalÄ±yor ---

    - name: ğŸ› ï¸ Android Build-Tools Kurulumu (Otomatik SÃ¼rÃ¼m)
      run: |
        ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH

        echo "ğŸ“¦ Android SDK bileÅŸenleri yÃ¼kleniyor..."

        # LisanslarÄ± otomatik kabul et
        yes | sdkmanager --licenses || true

        # En son build-tools sÃ¼rÃ¼mÃ¼nÃ¼ al
        LATEST_BUILD_TOOLS=$(sdkmanager --list | grep "build-tools;" | awk '{print $1}' | sort -V | tail -n1)
        echo "ğŸ“Œ En son build-tools sÃ¼rÃ¼mÃ¼: $LATEST_BUILD_TOOLS"

        # Gerekli bileÅŸenleri yÃ¼kle
        sdkmanager --install \
          "$LATEST_BUILD_TOOLS" \
          "platforms;android-33" \
          "platform-tools" \
          "cmdline-tools;latest"

        echo "âœ… Android SDK bileÅŸenleri kuruldu"
        echo "ğŸ“Œ Kurulu build-tools: $LATEST_BUILD_TOOLS"

    - name: ğŸ” Kurulum DoÄŸrulama
      run: |
        ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/*:$PATH

        echo "ğŸ“‹ Kurulu Build-Tools ve aidl kontrolÃ¼"
        which aidl || echo "âš ï¸ aidl PATH'de bulunamadÄ±"
        ls -la $ANDROID_HOME/build-tools/
