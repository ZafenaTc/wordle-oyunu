name: Android APK Derleme (DÃ¼zeltilmiÅŸ)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v3
    
    - name: ğŸ Python Kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: â˜• Java Kurulumu
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: ğŸ“¦ Sistem BaÄŸÄ±mlÄ±lÄ±klarÄ±
      run: |
        sudo apt update
        sudo apt install -y \
          git zip unzip \
          autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev \
          libncursesw5-dev libtinfo5 \
          cmake libffi-dev libssl-dev \
          automake ccache \
          libltdl-dev
    
    - name: ğŸ”§ Buildozer Kurulumu
      run: |
        pip install --upgrade pip
        pip install buildozer==1.5.0 cython==0.29.36
    
    # ====== DÃœZELTME: Android SDK ve Build-Tools Kurulumu ======
    - name: ğŸ¤– Android SDK Kurulumu
      run: |
        # Android SDK dizinini oluÅŸtur
        mkdir -p $HOME/.buildozer/android/platform/android-sdk
        cd $HOME/.buildozer/android/platform/android-sdk
        
        # Command Line Tools indir
        echo "ğŸ“¥ Android Command Line Tools indiriliyor..."
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
        
        # Ã‡Ä±kart
        unzip -q cmdline-tools.zip
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
        
        # Ortam deÄŸiÅŸkenleri
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
        
        echo "âœ… Command Line Tools kuruldu"
        
    - name: ğŸ› ï¸ Android Build-Tools Kurulumu (DÃœZELTME)
      run: |
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
        
        echo "ğŸ“¦ Android SDK bileÅŸenleri yÃ¼kleniyor..."
        
        # LisanslarÄ± otomatik kabul et
        yes | sdkmanager --licenses || true
        
        # Gerekli bileÅŸenleri yÃ¼kle
        sdkmanager --install \
          "build-tools;34.0.0" \
          "platforms;android-33" \
          "platform-tools" \
          "cmdline-tools;latest"
        
        echo "âœ… Build-Tools 34.0.0 kuruldu"
        echo "âœ… Platform-Tools kuruldu"
        
        # Kurulum kontrolÃ¼
        ls -la $ANDROID_HOME/build-tools/
        
    - name: ğŸ” Kurulum DoÄŸrulama
      run: |
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
        export PATH=$ANDROID_HOME/platform-tools:$PATH
        export PATH=$ANDROID_HOME/build-tools/34.0.0:$PATH
        
        echo "ğŸ“‹ SDK Bilgileri:"
        sdkmanager --list_installed
        
        echo ""
        echo "ğŸ“‹ Build-Tools Konumu:"
        which aidl || echo "âš ï¸ aidl PATH'de bulunamadÄ±"
        
        echo ""
        echo "ğŸ“‹ Dosya KontrolÃ¼:"
        ls -la $ANDROID_HOME/build-tools/34.0.0/ || echo "âš ï¸ build-tools klasÃ¶rÃ¼ bulunamadÄ±"
    
    - name: ğŸ“ buildozer.spec OluÅŸtur/GÃ¼ncelle
      run: |
        if [ ! -f buildozer.spec ]; then
          echo "ğŸ“ buildozer.spec oluÅŸturuluyor..."
          buildozer init
        fi
        
        # Ã–nemli ayarlarÄ± gÃ¼ncelle
        sed -i 's/title = .*/title = Wordle Oyunu/' buildozer.spec
        sed -i 's/package.name = .*/package.name = wordleoyunu/' buildozer.spec
        sed -i 's/package.domain = .*/package.domain = com.wordle/' buildozer.spec
        sed -i 's/source.include_exts = .*/source.include_exts = py,png,jpg,kv,atlas,txt,json,wav/' buildozer.spec
        sed -i 's/version = .*/version = 1.0.0/' buildozer.spec
        
        # Requirements - KivyMD iÃ§in gerekli baÄŸÄ±mlÄ±lÄ±klar
        sed -i 's/requirements = .*/requirements = python3,kivy==2.2.1,kivymd,pillow,sdl2_ttf/' buildozer.spec
        
        # Android ayarlarÄ± - DÃœZELTME
        sed -i 's/android.permissions = .*/android.permissions = INTERNET,ACCESS_NETWORK_STATE/' buildozer.spec
        sed -i 's/android.api = .*/android.api = 33/' buildozer.spec
        sed -i 's/android.minapi = .*/android.minapi = 21/' buildozer.spec
        sed -i 's/android.ndk = .*/android.ndk = 25b/' buildozer.spec
        sed -i 's/android.accept_sdk_license = .*/android.accept_sdk_license = True/' buildozer.spec
        
        # Build-tools sÃ¼rÃ¼mÃ¼nÃ¼ ekle (DÃœZELTME)
        if ! grep -q "android.build_tools_version" buildozer.spec; then
          echo "android.build_tools_version = 34.0.0" >> buildozer.spec
        fi
        
        # SDK path'i ekle (DÃœZELTME)
        if ! grep -q "android.sdk_path" buildozer.spec; then
          echo "android.sdk_path = $HOME/.buildozer/android/platform/android-sdk" >> buildozer.spec
        fi
        
        # Mimari
        sed -i 's/android.archs = .*/android.archs = arm64-v8a/' buildozer.spec
        
        echo "âœ… buildozer.spec yapÄ±landÄ±rÄ±ldÄ±"
        
    - name: ğŸ’¾ Buildozer Cache
      uses: actions/cache@v3
      with:
        path: |
          .buildozer
          !.buildozer/android/platform/android-sdk
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}-v3
        restore-keys: |
          ${{ runner.os }}-buildozer-v3-
    
    - name: ğŸ—ï¸ APK Derleme
      run: |
        # Ortam deÄŸiÅŸkenlerini ayarla
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
        export PATH=$ANDROID_HOME/platform-tools:$PATH
        export PATH=$ANDROID_HOME/build-tools/34.0.0:$PATH
        
        echo "ğŸš€ Derleme baÅŸlÄ±yor..."
        echo "ğŸ“ ANDROID_HOME: $ANDROID_HOME"
        
        # Derleme
        buildozer -v android debug
        
        echo "âœ… Derleme tamamlandÄ±!"
        
    - name: ğŸ“Š APK Bilgileri
      if: success()
      run: |
        echo "ğŸ“¦ OluÅŸturulan APK dosyalarÄ±:"
        ls -lh bin/*.apk
        
        echo ""
        echo "ğŸ“ APK boyutu:"
        du -h bin/*.apk
        
    - name: ğŸ“¤ APK Upload
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: wordle-apk
        path: bin/*.apk
        retention-days: 30
    
    - name: ğŸ‰ Release OluÅŸtur (Tag varsa)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“‹ Derleme LoglarÄ± (Hata durumunda)
      if: failure()
      run: |
        echo "âŒ Derleme baÅŸarÄ±sÄ±z oldu!"
        echo ""
        echo "ğŸ“‹ Son 100 satÄ±r log:"
        tail -n 100 .buildozer/logs/last_log.txt || echo "Log dosyasÄ± bulunamadÄ±"
        
        echo ""
        echo "ğŸ“‹ Build-tools kontrolÃ¼:"
        ls -la $HOME/.buildozer/android/platform/android-sdk/build-tools/ || echo "Build-tools bulunamadÄ±"
