name: Android APK Derleme (DÃ¼zeltilmiÅŸ)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v3
    
    - name: ğŸ Python Kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: â˜• Java Kurulumu
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: ğŸ“¦ Sistem BaÄŸÄ±mlÄ±lÄ±klarÄ±
      run: |
        sudo apt update
        sudo apt install -y \
          git zip unzip \
          autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev \
          libncursesw5-dev libtinfo6 \
          cmake libffi-dev libssl-dev \
          automake ccache \
          libltdl-dev wget
    
    - name: ğŸ”§ Buildozer Kurulumu
      run: |
        pip install --upgrade pip
        pip install buildozer==1.5.0 cython==0.29.36
    
    - name: ğŸ“± Android SDK Kurulumu
      run: |
        ANDROID_SDK=$HOME/.buildozer/android/platform/android-sdk
        mkdir -p $ANDROID_SDK
        cd $ANDROID_SDK
    
        rm -rf $ANDROID_SDK/cmdline-tools
    
        curl -Lo cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q cmdline-tools.zip
        rm cmdline-tools.zip
    
        # Ã‡Ä±kan klasÃ¶r adÄ±nÄ± dinamik bul
        DIR=$(find . -maxdepth 1 -type d -name "cmdline-tools*" ! -name "cmdline-tools" | head -n 1)
    
        mkdir -p $ANDROID_SDK/cmdline-tools/latest
        mv "$DIR"/* $ANDROID_SDK/cmdline-tools/latest/
    
        echo "ANDROID_HOME=$ANDROID_SDK" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK" >> $GITHUB_ENV
        echo "$ANDROID_SDK/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK/platform-tools" >> $GITHUB_PATH
        echo "$ANDROID_SDK/build-tools/34.0.0" >> $GITHUB_PATH
    
        yes | sdkmanager --licenses
        sdkmanager --install \
          "build-tools;34.0.0" \
          "platforms;android-33" \
          "platform-tools"

    
    - name: ğŸ” Kurulum Kontrol
      run: |
        sdkmanager --list || true
        which sdkmanager || true
        which aidl || true
    
    - name: ğŸ“ buildozer.spec GÃ¼ncelle
      run: |
        if [ ! -f buildozer.spec ]; then
          buildozer init
        fi
        
        sed -i 's/title = .*/title = Wordle Oyunu/' buildozer.spec
        sed -i 's/package.name = .*/package.name = wordleoyunu/' buildozer.spec
        sed -i 's/package.domain = .*/package.domain = com.wordle/' buildozer.spec
        sed -i 's/source.include_exts = .*/source.include_exts = py,png,jpg,kv,atlas,txt,json,wav/' buildozer.spec
        sed -i 's/version = .*/version = 1.0.0/' buildozer.spec
        sed -i 's/requirements = .*/requirements = python3,kivy==2.2.1,kivymd,pillow,sdl2_ttf/' buildozer.spec
        sed -i 's/android.permissions = .*/android.permissions = INTERNET,ACCESS_NETWORK_STATE/' buildozer.spec
        sed -i 's/android.api = .*/android.api = 33/' buildozer.spec
        sed -i 's/android.minapi = .*/android.minapi = 21/' buildozer.spec
        sed -i 's/android.ndk = .*/android.ndk = 25b/' buildozer.spec
        sed -i 's/android.accept_sdk_license = .*/android.accept_sdk_license = True/' buildozer.spec
    
        if ! grep -q "android.build_tools_version" buildozer.spec; then
          echo "android.build_tools_version = 34.0.0" >> buildozer.spec
        fi
    
        if ! grep -q "android.sdk_path" buildozer.spec; then
          echo "android.sdk_path = $HOME/.buildozer/android/platform/android-sdk" >> buildozer.spec
        fi
        
        sed -i 's/android.archs = .*/android.archs = arm64-v8a/' buildozer.spec
    
    - name: ğŸ’¾ Buildozer Cache
      uses: actions/cache@v3
      with:
        path: |
          .buildozer
          !.buildozer/android/platform/android-sdk
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}-v3
        restore-keys: |
          ${{ runner.os }}-buildozer-v3-
    
    - name: ğŸ—ï¸ APK Derleme
      run: |
        buildozer -v android debug
    
    - name: ğŸ“¤ APK Upload
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: wordle-apk
        path: bin/*.apk
        retention-days: 30
    
    - name: ğŸ“‹ Derleme LoglarÄ± (Hata durumunda)
      if: failure()
      run: |
        tail -n 200 .buildozer/logs/last_log.txt || echo "Log dosyasÄ± yok"
